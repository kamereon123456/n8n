# 工作流名称，可自定义
name: Build n8n Docker Image And Export Offline Tar

# 触发规则：提交代码到main分支时自动构建，也可以手动触发
on:
  push:
    branches: [ main ]
  workflow_dispatch: # 手动触发开关，重点！在仓库Actions页面可以手动点"运行工作流"

# 工作流核心任务
jobs:
  build-and-export:
    # 使用GitHub官方的Ubuntu云端环境，预装了Docker，无需手动安装
    runs-on: ubuntu-latest
    steps:
      # 步骤1：拉取当前仓库的n8n源码到云端服务器
      - name: Checkout n8n source code
        uses: actions/checkout@v4

      # 步骤2：构建n8n的Docker镜像，指定镜像名称和版本
      - name: Build n8n Docker Image
        run: |
          docker build -t n8n-custom:latest .
          # 查看构建后的镜像信息，验证构建成功
          docker images | grep n8n-custom

      # 步骤3：将Docker镜像导出为【离线tar包】，核心离线步骤
      - name: Export Docker Image to Offline Tar File
        run: |
          # 导出镜像，文件名：n8n-offline-image.tar，这个文件就是最终要下载的离线包
          docker save -o n8n-offline-image.tar n8n-custom:latest
          # 查看文件大小，确认导出成功
          ls -lh n8n-offline-image.tar

      # 步骤4：上传离线tar包到GitHub Actions的构建产物，供浏览器下载
      - name: Upload Offline Tar Package to Artifacts
        uses: actions/upload-artifact@v4
        with:
          # 上传的文件路径（和上面导出的文件名一致）
          name: n8n-offline-image
          path: n8n-offline-image.tar
          # 保留产物90天，足够下载了
          retention-days: 3
